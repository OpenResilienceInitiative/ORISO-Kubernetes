apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "agencyservice.fullname" . }}-config
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "agencyservice.labels" . | nindent 4 }}
data:
  # Database Configuration - Use full Kubernetes DNS FQDN (required for managed clusters)
  SPRING_DATASOURCE_URL: {{ .Values.database.url | quote }}
  
  # Keycloak Configuration - Use global values if available, otherwise chart values
  KEYCLOAK_AUTH_SERVER_URL: {{ if and .Values.global .Values.global.keycloak .Values.global.keycloak.internalUrl }}{{ .Values.global.keycloak.internalUrl | quote }}{{ else }}{{ .Values.keycloak.authServerUrl | quote }}{{ end }}
  KEYCLOAK_REALM: {{ if and .Values.global .Values.global.keycloak .Values.global.keycloak.realm }}{{ .Values.global.keycloak.realm | quote }}{{ else }}{{ .Values.keycloak.realm | quote }}{{ end }}
  SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: {{ if and .Values.global .Values.global.keycloak .Values.global.keycloak.jwt .Values.global.keycloak.jwt.issuerUri }}{{ .Values.global.keycloak.jwt.issuerUri | quote }}{{ else }}{{ .Values.keycloak.jwt.issuerUri | quote }}{{ end }}
  SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: {{ if and .Values.global .Values.global.keycloak .Values.global.keycloak.jwt .Values.global.keycloak.jwt.jwkSetUri }}{{ .Values.global.keycloak.jwt.jwkSetUri | quote }}{{ else }}{{ .Values.keycloak.jwt.jwkSetUri | quote }}{{ end }}
  
  # MongoDB Configuration - Use full Kubernetes DNS FQDN (required for managed clusters)
  SPRING_DATA_MONGODB_URI: {{ .Values.mongodb.uri | quote }}
  
  # Matrix Configuration - Use global values if available, otherwise chart values
  MATRIX_API_URL: {{ if and .Values.global .Values.global.matrix .Values.global.matrix.internalUrl }}{{ .Values.global.matrix.internalUrl | quote }}{{ else }}{{ .Values.matrix.apiUrl | quote }}{{ end }}
  MATRIX_SERVER_NAME: {{ if and .Values.global .Values.global.matrix .Values.global.matrix.serverName }}{{ .Values.global.matrix.serverName | quote }}{{ else }}{{ .Values.matrix.serverName | quote }}{{ end }}
  
  # Service URLs - Use full Kubernetes DNS FQDN (required for managed clusters)
  CONSULTING_TYPE_SERVICE_API_URL: {{ .Values.services.consultingTypeService.apiUrl | quote }}
  TENANT_SERVICE_API_URL: {{ .Values.services.tenantService.apiUrl | quote }}
  USER_ADMIN_SERVICE_API_URL: {{ .Values.services.userAdminService.apiUrl | quote }}
  LIVE_SERVICE_API_URL: {{ .Values.services.liveService.apiUrl | quote }}
  APPOINTMENT_SERVICE_API_URL: {{ .Values.services.appointmentService.apiUrl | quote }}
  
  # Rocket.Chat Configuration - Use full Kubernetes DNS FQDN (required for managed clusters)
  ROCKET_CHAT_BASE_URL: {{ .Values.rocketchat.baseUrl | quote }}
  ROCKET_CHAT_MONGO_URL: {{ .Values.rocketchat.mongoUrl | quote }}
  
  # Feature Flags
  FEATURE_TOPICS_ENABLED: {{ .Values.features.topics.enabled | quote }}
  
  # Spring Profile
  SPRING_PROFILES_ACTIVE: {{ .Values.spring.profiles.active | quote }}
  
  # Liquibase - Explicitly disabled (database schemas managed separately in ORISO-Database)
  SPRING_LIQUIBASE_ENABLED: {{ .Values.database.liquibase.enabled | quote }}
