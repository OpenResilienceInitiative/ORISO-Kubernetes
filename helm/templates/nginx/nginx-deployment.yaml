apiVersion: v1
kind: ConfigMap
metadata:
  name: oriso-nginx-config
  namespace: {{ .Release.Namespace }}

data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        sendfile on;
        keepalive_timeout 65;

    server {
        listen 8089;
        server_name _;

        location /auth/ {
            proxy_hide_header Access-Control-Allow-Origin;
            proxy_hide_header Access-Control-Allow-Credentials;
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            rewrite ^/auth/(.*)$ /$1 break;
            proxy_pass http://keycloak.{{ .Release.Name }}:8080/;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Proto http;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /service/agencyadmin/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://agencyservice.{{ .Release.Name }}:8080/agencyadmin/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /service/appointmentservice/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://agencyservice.{{ .Release.Name }}:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /service/consultingtypes/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://consultingtypeservice.{{ .Release.Name }}:8080/consultingtypes/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /tenant/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://tenantservice.{{ .Release.Name }}:8081/tenant/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /service/tenant/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            rewrite ^/service/tenant/(.*)$ /tenant/$1 break;
            proxy_pass http://tenantservice.{{ .Release.Name }}:8081;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /service/settings {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://consultingtypeservice.{{ .Release.Name }}:8080/settings;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /service/settingsadmin {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://consultingtypeservice.{{ .Release.Name }}:8080/settingsadmin;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /service/conversations/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Allow-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            rewrite ^/service/conversations/(.*)$ /conversations/$1 break;
            proxy_pass http://userService.{{ .Release.Name }}:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /service/users/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            rewrite ^/service/users/(.*)$ /users/$1 break;
            proxy_pass http://userService.{{ .Release.Name }}:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /service/matrix/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            rewrite ^/service/matrix/(.*)$ /matrix/$1 break;
            proxy_pass http://userService.{{ .Release.Name }}:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /_matrix/media/ {
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Credentials';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';

            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, X-CSRF-TOKEN' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://matrix-synapse.{{ .Release.Name }}:8008;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 50M;
            proxy_request_buffering off;
        }

        location /service/useradmin/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://userService.{{ .Release.Name }}:8080/useradmin/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /service/tenantadmin/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://tenantservice.{{ .Release.Name }}:8081/tenantadmin/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /service/agencies {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://agencyservice.{{ .Release.Name }}:8080/agencies;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /service/topic/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, X-Requested-With, rcToken, rcUserId, rctoken, rcuserid, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://consultingtypeservice.{{ .Release.Name }}:8080/topic/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /service/topic-groups/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, x-csrf-token, X-CSRF-Bypass, x-csrf-bypass, X-Requested-With, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://consultingtypeservice.{{ .Release.Name }}:8080/topic-groups/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /service/topicadmin/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' $http_origin always;
                add_header 'Vary' 'Origin' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Cache-Control, Pragma, Expires, X-CSRF-Token, X-Requested-With, rcToken, rcUserId, rctoken, rcuserid, X-WHITELIST-HEADER' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                return 204;
            }
            add_header 'Access-Control-Allow-Origin' $http_origin always;
            add_header 'Vary' 'Origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;

            proxy_pass http://agencyservice.{{ .Release.Name }}:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /health/ {
            access_log off;
            return 200 'OK';
            add_header Content-Type text/plain;
        }

    }
    }

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cob-proxy
  namespace: caritas
  labels:
    app: cob-proxy
spec:
  replicas: 1
  revisionHistoryLimit: 1
  selector:
    matchLabels:
      app: cob-proxy
  template:
    metadata:
      labels:
        app: cob-proxy
    spec:
      #hostNetwork: true
      containers:
      - name: cob-proxy
        image: nginx:alpine
        ports:
        - containerPort: 8089
          protocol: TCP
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        livenessProbe:
          httpGet:
            path: /health/
            port: 8089
          initialDelaySeconds: 10
          periodSeconds: 30       
        readinessProbe:
          httpGet:
            path: /health/
            port: 8089
          initialDelaySeconds: 5
          periodSeconds: 10
      volumes:
      - name: nginx-config
        configMap:
          name: oriso-nginx-config
---
apiVersion: v1
kind: Service
metadata:
  name: cob-proxy
  namespace: caritas
  labels:
    app: cob-proxy
spec:
  selector:
    app: cob-proxy
  ports:
  - port: 8089
    targetPort: 8089
    protocol: TCP
  type: ClusterIP